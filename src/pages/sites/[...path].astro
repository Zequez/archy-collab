---
import Layout from "@layouts/Layout.astro";
import NavItem from "@components/NavItem.astro";
import ezequiel from "@/agents/ezequiel.yml";
import nick from "@/agents/nick.yml";
import defaultAgent from "@/agents/default.yml";
import Nav from "@components/Nav";

const agents: { [key: string]: Agent } = { ezequiel, nick, defaultAgent };

const { path } = Astro.params;

type RouteInformation = {
  domainName: string;
  pageName: string;
};

function extractRouteInformation(path: string = ""): RouteInformation {
  const [domainName, ...ppp] = path.split("/");
  const pageName = ppp.join("/");

  return { pageName, domainName };
}

const { pageName, domainName } = extractRouteInformation(path);

function selectActiveAgent(domainName: string) {
  return agents[domainName] || agents.defaultAgent;
}

const agent = selectActiveAgent(domainName);

console.log("RouteInformation", pageName, domainName);
console.log("PATH", path);

const activePath = ((path || "").match(/\/[a-z]+$/) || [null])[0] || "/";

function addColorsToModules(modules: Module[]): Module[] {
  let currentColor = 10;
  for (let i = 0; i < agent.modules.length; ++i) {
    agent.modules[i].color = currentColor;
    currentColor += 50;
  }
  return modules;
}

addColorsToModules(agent.modules);

const activeModule = agent.modules.find((m) => m.path === activePath);
---

<Layout title="App" favicon="" themeColor="">
  <div class="flex flex-col sm:flex-row h-full">
    <header
      class="relative z-10 overflow-hidden w-full h-1/2 sm:h-auto sm:w-1/2 sm:max-w-[600px]"
    >
      <div class="absolute z-0 inset-0">
        <img
          src={agent.background}
          class="w-full h-full object-cover object-center"
        />
      </div>
      <div
        class="absolute z-10 inset-0 flex flex-col items-center justify-center transition-opacity pb-0 sm:pb-16 md:pb-0"
      >
        <div
          class="relative mb-4 h-3/4 sm:h-auto sm:w-3/4 aspect-square object-cover rounded-full p-1 bg-white/50 border border-solid border-white/25 shadow-lg backdrop-blur-sm"
          style={{ animation: "wait 0.5s, scaleFadeIn 1.5s 0.5s" }}
        >
          <img src={agent.photo} class="w-full h-full rounded-full" />
        </div>
        <h1
          class="text-5xl text-white text-center font-thin whitespace-nowrap sm:whitespace-normal"
          style={{ textShadow: "0 1px 0 #0005, 0 0 5px #000" }}
        >
          {agent.name}
        </h1>
      </div>
    </header>
    <Nav
      modules={agent.modules}
      initialPath={`/${pageName}`}
      bgColor={agent.navColor}
      client:load
    />
    <main
      class="relative z-20 flex-grow min-h-[50%] sm:w-1/2 border-t-4 sm:border-t-0 sm:border-l-4 border-black/20 bg-[#F2D7B5]"
    >
      <div
        class="sm:absolute pb-20 sm:pb-0 sm:inset-0 z-0 p-6 text-lg font-light text-black/75 tracking-wide sm:overflow-auto transition-opacity transition-swup"
        id="swup"
      >
        {
          activeModule ? (
            <>
              <h2 class="uppercase text-4xl mb-3 font-black">
                {activeModule.name}
              </h2>
              <p>{activeModule.value}</p>
              <p class="">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                Pellentesque vel fringilla diam, euismod pulvinar tellus. Sed
                sed lorem ultricies, finibus massa sit amet, lobortis felis.
                Donec semper velit non interdum congue. Vestibulum ac
                sollicitudin leo. Vivamus vitae odio massa. Vivamus lacinia
                placerat magna at varius. Nunc non ligula ut libero rutrum
                sollicitudin. Nam porta ultricies quam ac sodales. Integer
                aliquam congue massa in imperdiet. Aliquam erat volutpat. In
                eleifend dolor eget risus suscipit tempus. Cras accumsan est
                eleifend, iaculis odio nec, vestibulum enim. Vivamus molestie
                ullamcorper odio at lacinia. Phasellus vel finibus ipsum. Nam
                efficitur odio nibh, quis fringilla sapien dapibus non. Aenean
                auctor purus non nibh elementum rutrum.
              </p>
            </>
          ) : (
            "404"
          )
        }
      </div>
    </main>
  </div>

  <script>
    import Swup from "swup";
    const swup = new Swup({
      /* options */
    });
    (window as any).swup = swup;

    function init() {
      console.log("Init!");
    }

    function unload() {
      console.log("Unloading");
    }

    if (document.readyState === "complete") {
      init();
    } else {
      document.addEventListener("DOMContentLoaded", () => init());
    }

    swup.on("contentReplaced", init);
    swup.on("willReplaceContent", unload);
  </script>
</Layout>
